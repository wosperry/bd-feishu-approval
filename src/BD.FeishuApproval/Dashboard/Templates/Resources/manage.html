<!DOCTYPE html>
<html lang='zh-CN'>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>é£ä¹¦ç®¡ç†é¡µ - ç³»ç»Ÿé…ç½®</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            color: white;
        }
        
        .header-left h1 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .header-left p {
            opacity: 0.8;
            font-size: 0.875rem;
        }
        
        .header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .back-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .setup-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }
        
        .card-desc {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .form-section {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .form-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            color: var(--text);
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .actions-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            line-height: 1.4;
        }
        
        .help-text {
            background: #f0f9ff;
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
            font-size: 0.875rem;
        }
        
        .help-text h4 {
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .help-text ol {
            padding-left: 1.25rem;
        }
        
        .help-text li {
            margin-bottom: 0.25rem;
        }
        
        .output-card {
            border-top: 4px solid var(--primary);
        }
        
        .output-area {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            z-index: 1000;
            min-width: 300px;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--danger);
        }
        
        @media (max-width: 768px) {
            .setup-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .actions-row {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <div class='header-left'>
                <h1>âš™ï¸ ç³»ç»Ÿç®¡ç†</h1>
                <p>é…ç½®é£ä¹¦åº”ç”¨å‡­è¯ã€ç®¡ç†å®¡æ‰¹æµç¨‹ã€ç”Ÿæˆä»£ç æ¨¡æ¿</p>
            </div>
            <div class='header-right'>
                <a href='/api/docs' class='back-btn' style='margin-right: 1rem;'>ğŸ“š APIæ–‡æ¡£</a>
                <a href='{{PathPrefix}}' class='back-btn'>â† è¿”å›æ§åˆ¶é¢æ¿</a>
            </div>
        </div>
        
        <div class='setup-grid'>
            <!-- ç®¡ç†å£ä»¤è®¾ç½®/éªŒè¯ -->
            <div class='card' id='passwordCard'>
                <div class='card-header'>
                    <div class='step-number'>1</div>
                    <div>
                        <div class='card-title' id='passwordTitle'>ç®¡ç†å£ä»¤è®¾ç½®</div>
                        <div class='card-desc' id='passwordDesc'>é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®ç®¡ç†å£ä»¤ä»¥ä¿æŠ¤ç³»ç»Ÿå®‰å…¨</div>
                    </div>
                </div>
                
                <!-- åˆå§‹åŒ–å¯†ç ç•Œé¢ -->
                <div class='form-section' id='initPasswordSection'>
                    <div class='form-row'>
                        <input id='newPwd' type='password' placeholder='è®¾ç½®ç®¡ç†å£ä»¤ï¼ˆè‡³å°‘6ä½ï¼‰' class='form-input'>
                        <input id='confirmPwd' type='password' placeholder='ç¡®è®¤ç®¡ç†å£ä»¤' class='form-input'>
                    </div>
                    <div class='form-row'>
                        <button class='btn btn-primary' onclick='initPassword()'>
                            ğŸ”’ è®¾ç½®å£ä»¤
                        </button>
                    </div>
                    <div class='hint'>è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„ç®¡ç†å£ä»¤ï¼Œé—å¤±åéœ€è¦é‡æ–°éƒ¨ç½²ç³»ç»Ÿ</div>
                </div>

                <!-- éªŒè¯å¯†ç ç•Œé¢ -->
                <div class='form-section' id='verifyPasswordSection' style='display: none;'>
                    <div class='form-row'>
                        <input id='pwd' type='password' placeholder='è¾“å…¥ç®¡ç†å£ä»¤è¿›è¡ŒéªŒè¯' class='form-input'>
                        <button class='btn btn-outline' onclick='verifyPwd()'>
                            ğŸ” éªŒè¯å£ä»¤
                        </button>
                    </div>
                    <div class='form-row'>
                        <button class='btn btn-outline' onclick='showChangePassword()' style='margin-top: 0.5rem;'>
                            ğŸ”‘ ä¿®æ”¹å£ä»¤
                        </button>
                    </div>
                    <div class='hint'>ç®¡ç†å£ä»¤ç”¨äºä¿æŠ¤ç³»ç»Ÿé…ç½®å®‰å…¨</div>
                </div>

                <!-- ä¿®æ”¹å¯†ç ç•Œé¢ -->
                <div class='form-section' id='changePasswordSection' style='display: none;'>
                    <div class='form-row'>
                        <input id='oldPwd' type='password' placeholder='å½“å‰ç®¡ç†å£ä»¤ï¼ˆå¦‚æœªè®¾ç½®å¯ç•™ç©ºï¼‰' class='form-input'>
                    </div>
                    <div class='form-row'>
                        <input id='newPwdChange' type='password' placeholder='æ–°ç®¡ç†å£ä»¤ï¼ˆè‡³å°‘6ä½ï¼‰' class='form-input'>
                        <input id='confirmPwdChange' type='password' placeholder='ç¡®è®¤æ–°ç®¡ç†å£ä»¤' class='form-input'>
                    </div>
                    <div class='form-row'>
                        <button class='btn btn-primary' onclick='changePassword()'>
                            ğŸ”„ è®¾ç½®/ä¿®æ”¹å£ä»¤
                        </button>
                        <button class='btn btn-outline' onclick='cancelChangePassword()'>
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                    <div class='hint'>é¦–æ¬¡è®¾ç½®æ—¶å¯ä¸å¡«å†™å½“å‰å£ä»¤ï¼Œä¿®æ”¹åè¯·å¦¥å–„ä¿ç®¡æ–°çš„ç®¡ç†å£ä»¤</div>
                </div>
            </div>

            <!-- é£ä¹¦åº”ç”¨é…ç½® -->
            <div class='card'>
                <div class='card-header'>
                    <div class='step-number'>2</div>
                    <div>
                        <div class='card-title'>é£ä¹¦åº”ç”¨é…ç½®</div>
                        <div class='card-desc'>é…ç½®é£ä¹¦å¼€æ”¾å¹³å°çš„åº”ç”¨å‡­è¯</div>
                    </div>
                </div>
                
                <div class='form-section'>
                    <label class='form-label'>App ID (å¿…å¡«)</label>
                    <div class='form-row'>
                        <input id='appId' placeholder='cli_a1234567890abcde' class='form-input'>
                    </div>
                    
                    <div class='help-text'>
                        <h4>ğŸ“± å¦‚ä½•è·å– App IDï¼Ÿ</h4>
                        <ol>
                            <li>ç™»å½• <a href='https://open.feishu.cn/app' target='_blank'>é£ä¹¦å¼€æ”¾å¹³å°</a></li>
                            <li>é€‰æ‹©ä½ çš„åº”ç”¨ï¼ˆå¦‚æœæ²¡æœ‰åº”ç”¨ï¼Œç‚¹å‡»"åˆ›å»ºåº”ç”¨"ï¼‰</li>
                            <li>è¿›å…¥"åº”ç”¨ä¿¡æ¯" â†’ "åŸºç¡€ä¿¡æ¯"</li>
                            <li>å¤åˆ¶"App ID"å­—æ®µçš„å€¼ï¼ˆæ ¼å¼ï¼šcli_xxxxxxxï¼‰</li>
                        </ol>
                    </div>
                </div>
                
                <div class='form-section'>
                    <label class='form-label'>App Secret (å¿…å¡«)</label>
                    <div class='form-row'>
                        <input id='appSecret' placeholder='åº”ç”¨å¯†é’¥' type='password' class='form-input'>
                    </div>
                    
                    <div class='help-text'>
                        <h4>ğŸ” å¦‚ä½•è·å– App Secretï¼Ÿ</h4>
                        <ol>
                            <li>åœ¨é£ä¹¦å¼€æ”¾å¹³å°çš„åº”ç”¨é¡µé¢</li>
                            <li>è¿›å…¥"åº”ç”¨ä¿¡æ¯" â†’ "åŸºç¡€ä¿¡æ¯"</li>
                            <li>æ‰¾åˆ°"App Secret"å­—æ®µï¼Œç‚¹å‡»"æŸ¥çœ‹"æŒ‰é’®</li>
                            <li>å¤åˆ¶æ˜¾ç¤ºçš„å¯†é’¥å€¼</li>
                        </ol>
                        <p><strong>âš ï¸ æ³¨æ„ï¼š</strong> App Secret æ˜¯æ•æ„Ÿä¿¡æ¯ï¼Œè¯·å¦¥å–„ä¿ç®¡</p>
                    </div>
                </div>
                
                <div class='form-section'>
                    <label class='form-label'>å¯é€‰é…ç½®</label>
                    <div class='form-row'>
                        <input id='encryptKey' placeholder='æ¶ˆæ¯åŠ å¯†Key (å¯é€‰)' class='form-input'>
                        <input id='vt' placeholder='äº‹ä»¶è®¢é˜…Token (å¯é€‰)' class='form-input'>
                    </div>
                    <div class='hint'>å¦‚æœåªç”¨äºå‘èµ·å®¡æ‰¹ï¼Œå¯é€‰é…ç½®é¡¹å¯ä»¥ç•™ç©º</div>
                </div>
                
                <div class='actions-row'>
                    <button class='btn btn-primary' onclick='saveCfg()'>
                        ğŸ’¾ ä¿å­˜é…ç½®
                    </button>
                    <button class='btn btn-outline' onclick='checkCfg()'>
                        ğŸ” æ£€æµ‹çŠ¶æ€
                    </button>
                </div>
            </div>

            <!-- å®¡æ‰¹æµç¨‹ç™»è®° -->
            <div class='card'>
                <div class='card-header'>
                    <div class='step-number'>3</div>
                    <div>
                        <div class='card-title'>å®¡æ‰¹æµç¨‹ç™»è®°</div>
                        <div class='card-desc'>ç™»è®°é£ä¹¦å®¡æ‰¹çš„ approval_code</div>
                    </div>
                </div>
                
                <div class='help-text'>
                    <h4>ğŸ“‹ å¦‚ä½•è·å–å®¡æ‰¹ä»£ç ï¼Ÿ</h4>
                    <ol>
                        <li>ç™»å½• <a href='https://www.feishu.cn/approval/create' target='_blank'>é£ä¹¦å®¡æ‰¹ç®¡ç†åå°</a></li>
                        <li>åˆ›å»ºæˆ–æ‰¾åˆ°ä½ çš„å®¡æ‰¹åº”ç”¨</li>
                        <li>åœ¨åº”ç”¨è®¾ç½®ä¸­æ‰¾åˆ°"å®¡æ‰¹ä»£ç "ï¼ˆUUIDæ ¼å¼ï¼‰</li>
                        <li>ç¡®ä¿é£ä¹¦åº”ç”¨å·²å¼€é€š"å®¡æ‰¹"APIæƒé™</li>
                    </ol>
                </div>
                
                <div class='form-section'>
                    <div class='form-row'>
                        <input id='approvalCode' placeholder='7C468A54-8745-2245-9675-08DC917F109D' class='form-input'>
                        <input id='displayName' placeholder='æ˜¾ç¤ºåç§° (å¦‚ï¼šè¯·å‡ç”³è¯·)' class='form-input'>
                    </div>
                </div>
                
                <div class='actions-row'>
                    <button class='btn btn-primary' onclick='reg()'>
                        ğŸ“ ç™»è®°å®¡æ‰¹
                    </button>
                    <button class='btn btn-outline' onclick='loadRegistrations()'>
                        ğŸ“‹ æŸ¥çœ‹å·²ç™»è®°
                    </button>
                </div>
            </div>

            <!-- ä»£ç ç”Ÿæˆå™¨ -->
            <div class='card'>
                <div class='card-header'>
                    <div class='step-number'>4</div>
                    <div>
                        <div class='card-title'>ä»£ç ç”Ÿæˆå™¨</div>
                        <div class='card-desc'>è‡ªåŠ¨ç”Ÿæˆ C# è¯·æ±‚å®ä½“ç±»</div>
                    </div>
                </div>
                
                <div class='form-section'>
                    <label class='form-label'>å®¡æ‰¹ä»£ç  (å¿…å¡«)</label>
                    <div class='form-row'>
                        <input id='code' placeholder='å¦‚: leave_approval_001' class='form-input'>
                    </div>
                    
                    <label class='form-label'>ç”Ÿæˆçš„ç±»å (å¯é€‰)</label>
                    <div class='form-row'>
                        <input id='className' placeholder='å¦‚: LeaveApprovalRequest (ç•™ç©ºä½¿ç”¨é»˜è®¤åç§°)' class='form-input'>
                        <button class='btn btn-primary' onclick='gen()'>
                            ğŸš€ ç”Ÿæˆä»£ç 
                        </button>
                    </div>
                    <div class='hint'>
                        <strong>ç±»åè§„èŒƒï¼š</strong> ä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼Œå¦‚ LeaveApprovalRequestã€ExpenseReimbursementRequest ç­‰<br>
                        <strong>å®¡æ‰¹ä»£ç ï¼š</strong> ä»é£ä¹¦å®¡æ‰¹å®šä¹‰ä¸­è·å–ï¼Œé€šè¿‡ [ApprovalCode] ç‰¹æ€§å…³è”
                    </div>
                </div>
            </div>

            <!-- è¾“å‡ºç»“æœ -->
            <div class='card output-card'>
                <div class='card-header'>
                    <div style='width: 32px; height: 32px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;'>ğŸ“¤</div>
                    <div>
                        <div class='card-title'>è¾“å‡ºç»“æœ</div>
                        <div class='card-desc'>æ“ä½œç»“æœå’Œç”Ÿæˆçš„ä»£ç å°†åœ¨æ­¤æ˜¾ç¤º</div>
                    </div>
                </div>
                
                <div id='output' class='output-area'>
ç­‰å¾…æ“ä½œ...
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // è¿è¡Œæ—¶è¡¥ä¸ï¼šæ”¯æŒåœ¨æœªç»è¿‡åç«¯æ¨¡æ¿æ¸²æŸ“ï¼ˆä¾‹å¦‚ç›´æ¥ç”¨æ–‡ä»¶åè®®æˆ–IDEé™æ€æœåŠ¡ï¼‰æ—¶ï¼Œé€šè¿‡æŸ¥è¯¢å‚æ•° apiBase æˆ–åç«¯å›ºå®šé…ç½®æ¥å£è·å– ApiPrefix
        (function(){
            const originalFetch = window.fetch.bind(window);
            const urlParams = new URLSearchParams(location.search);
            const queryApiBase = urlParams.get('apiBase');

            // ç®€å•çš„å ä½ç¬¦æ£€æµ‹
            const isTemplateUnrendered = function(str){
                return typeof str === 'string' && str.indexOf('{{ApiPrefix}}') >= 0;
            };

            // è·å–åç«¯é…ç½®ï¼ˆå½“é€šè¿‡ http(s) è®¿é—®ä¸”æœªæä¾› apiBase æ—¶ï¼‰
            async function tryResolveApiBaseFromServer() {
                try {
                    // å°è¯•ä»å½“å‰é¡µé¢æ¨æ–­å‡º managePath å‰ç¼€ï¼Œå›é€€åˆ° /feishu
                    const base = location.origin;
                    // é»˜è®¤è·¯å¾„ï¼š/feishu/api/dashboard/config
                    const fallback = base + '/feishu/api/dashboard/config';
                    // å¦‚æœå½“å‰è·¯å¾„é‡ŒåŒ…å« /feishu/manageï¼Œåˆ™æ›¿æ¢ä¸º /feishu/api/dashboard/config
                    let guess = '';
                    if (location.pathname.includes('/manage')) {
                        guess = base + location.pathname.replace('/manage', '/api/dashboard/config');
                    }
                    const probe = guess || fallback;
                    const resp = await originalFetch(probe);
                    if (!resp.ok) throw new Error('config http ' + resp.status);
                    const data = await resp.json();
                    if (data && data.apiPrefix) return data.apiPrefix;
                } catch(_) { /* å¿½ç•¥ï¼Œèµ°å›é€€ */ }
                return '/feishu/api';
            }

            let resolvedApiBase = queryApiBase || null;

            window.fetch = async function(resource, init){
                try {
                    if (typeof resource === 'string' && isTemplateUnrendered(resource)) {
                        if (!resolvedApiBase) {
                            // ä»…å½“ http(s) åœºæ™¯æ‰å°è¯•è¯·æ±‚æœåŠ¡ç«¯é…ç½®
                            if (location.origin && location.origin.startsWith('http')) {
                                resolvedApiBase = await tryResolveApiBaseFromServer();
                            }
                            resolvedApiBase = resolvedApiBase || '/feishu/api';
                        }
                        resource = resource.replace('{{ApiPrefix}}', resolvedApiBase);
                    }
                } catch(_) { /* å®‰å…¨ä¿æŠ¤ */ }
                return originalFetch(resource, init);
            };
        })();

        let currentPassword = '';
        let hasAdminPassword = false;
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¯†ç çŠ¶æ€
        window.onload = async function() {
            await checkPasswordStatus();
        };
        
        // æ£€æŸ¥ç®¡ç†å‘˜å¯†ç çŠ¶æ€
        async function checkPasswordStatus() {
            try {
                const response = await fetch('{{ApiPrefix}}/admin-password/status');
                const result = await response.json();
                hasAdminPassword = result.hasPassword;
                
                if (hasAdminPassword) {
                    // å·²è®¾ç½®å¯†ç ï¼Œæ˜¾ç¤ºéªŒè¯ç•Œé¢
                    document.getElementById('passwordTitle').textContent = 'ç®¡ç†å£ä»¤éªŒè¯';
                    document.getElementById('passwordDesc').textContent = 'è¾“å…¥ç®¡ç†å£ä»¤ä»¥è¿›è¡Œç³»ç»Ÿé…ç½®';
                    document.getElementById('initPasswordSection').style.display = 'none';
                    document.getElementById('verifyPasswordSection').style.display = 'block';
                } else {
                    // æœªè®¾ç½®å¯†ç ï¼Œæ˜¾ç¤ºåˆå§‹åŒ–ç•Œé¢
                    document.getElementById('passwordTitle').textContent = 'ç®¡ç†å£ä»¤è®¾ç½®';
                    document.getElementById('passwordDesc').textContent = 'é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®ç®¡ç†å£ä»¤ä»¥ä¿æŠ¤ç³»ç»Ÿå®‰å…¨';
                    document.getElementById('initPasswordSection').style.display = 'block';
                    document.getElementById('verifyPasswordSection').style.display = 'none';
                }
                document.getElementById('changePasswordSection').style.display = 'none';
            } catch (error) {
                console.error('æ£€æŸ¥å¯†ç çŠ¶æ€å¤±è´¥:', error);
                showToast('æ£€æŸ¥å¯†ç çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = 'toast ' + (type || 'success');
            toast.innerHTML = '<div style="font-weight: 500; margin-bottom: 0.25rem;">' + (type === 'error' ? 'âŒ é”™è¯¯' : 'âœ… æˆåŠŸ') + '</div><div>' + message + '</div>';
            document.body.appendChild(toast);
            
            setTimeout(function() { toast.classList.add('show'); }, 100);
            setTimeout(function() {
                toast.classList.remove('show');
                setTimeout(function() { document.body.removeChild(toast); }, 300);
            }, 3000);
        }
        
        function updateOutput(content, type) {
            const output = document.getElementById('output');
            output.textContent = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
            output.className = 'output-area';
        }
        
        // åˆå§‹åŒ–å¯†ç 
        async function initPassword() {
            const newPwd = document.getElementById('newPwd').value;
            const confirmPwd = document.getElementById('confirmPwd').value;
            
            if (!newPwd || !newPwd.trim()) {
                showToast('è¯·è¾“å…¥æ–°å¯†ç ', 'error');
                return;
            }
            
            if (newPwd.length < 6) {
                showToast('å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            try {
                const response = await fetch('{{ApiPrefix}}/admin/password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: newPwd
                    })
                });
                
                if (response.ok) {
                    showToast('ç®¡ç†å£ä»¤è®¾ç½®æˆåŠŸ');
                    currentPassword = newPwd;
                    hasAdminPassword = true;
                    updateOutput('âœ… ç®¡ç†å£ä»¤å·²è®¾ç½®å¹¶ç¼“å­˜\n\nç°åœ¨å¯ä»¥è¿›è¡Œé…ç½®ä¿å­˜å’Œå®¡æ‰¹ç™»è®°æ“ä½œ');
                    await checkPasswordStatus(); // åˆ·æ–°ç•Œé¢çŠ¶æ€
                } else {
                    const errorText = await response.text();
                    showToast('è®¾ç½®å¤±è´¥: ' + errorText, 'error');
                    updateOutput('âŒ è®¾ç½®å¤±è´¥: ' + errorText);
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                updateOutput('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        function verifyPwd() {
            const pwd = document.getElementById('pwd').value;
            if (!pwd || !pwd.trim()) {
                showToast('è¯·è¾“å…¥ç®¡ç†å£ä»¤', 'error');
                return;
            }
            
            currentPassword = pwd;
            showToast('å£ä»¤å·²ç¼“å­˜ï¼Œå¯ç”¨äºåç»­æ“ä½œ');
            updateOutput('âœ… ç®¡ç†å£ä»¤å·²éªŒè¯å¹¶ç¼“å­˜\n\nç°åœ¨å¯ä»¥è¿›è¡Œé…ç½®ä¿å­˜å’Œå®¡æ‰¹ç™»è®°æ“ä½œ', 'success');
        }

        // æ˜¾ç¤ºä¿®æ”¹å¯†ç ç•Œé¢
        function showChangePassword() {
            document.getElementById('verifyPasswordSection').style.display = 'none';
            document.getElementById('changePasswordSection').style.display = 'block';
            document.getElementById('passwordTitle').textContent = 'ä¿®æ”¹ç®¡ç†å£ä»¤';
            document.getElementById('passwordDesc').textContent = 'è¯·è¾“å…¥å½“å‰å£ä»¤å’Œæ–°å£ä»¤';
        }

        // å–æ¶ˆä¿®æ”¹å¯†ç 
        function cancelChangePassword() {
            document.getElementById('changePasswordSection').style.display = 'none';
            document.getElementById('verifyPasswordSection').style.display = 'block';
            document.getElementById('passwordTitle').textContent = 'ç®¡ç†å£ä»¤éªŒè¯';
            document.getElementById('passwordDesc').textContent = 'è¾“å…¥ç®¡ç†å£ä»¤ä»¥è¿›è¡Œç³»ç»Ÿé…ç½®';
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('oldPwd').value = '';
            document.getElementById('newPwdChange').value = '';
            document.getElementById('confirmPwdChange').value = '';
        }

        // ä¿®æ”¹å¯†ç 
        async function changePassword() {
            const oldPwd = document.getElementById('oldPwd').value;
            const newPwd = document.getElementById('newPwdChange').value;
            const confirmPwd = document.getElementById('confirmPwdChange').value;
            
            if (!newPwd || !newPwd.trim()) {
                showToast('è¯·è¾“å…¥æ–°å¯†ç ', 'error');
                return;
            }
            
            if (newPwd.length < 6) {
                showToast('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            
            try {
                // å…ˆæ£€æŸ¥æ˜¯å¦å·²è®¾ç½®å¯†ç 
                const statusResponse = await fetch('{{ApiPrefix}}/admin-password/status', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!statusResponse.ok) {
                    showToast('æ£€æŸ¥å¯†ç çŠ¶æ€å¤±è´¥', 'error');
                    return;
                }
                
                const statusData = await statusResponse.json();
                const hasPassword = statusData.hasPassword;
                
                // å¦‚æœå·²è®¾ç½®å¯†ç ï¼Œéœ€è¦éªŒè¯æ—§å¯†ç 
                if (hasPassword) {
                    if (!oldPwd || !oldPwd.trim()) {
                        // éå¿…é¡»æç¤ºï¼šä¸å†å¼¹å‡ºé”™è¯¯ï¼Œä»…èšç„¦è¾“å…¥æ¡†
                        document.getElementById('oldPwd').focus();
                        return;
                    }
                    
                    // éªŒè¯æ—§å¯†ç 
                    const verifyResponse = await fetch('{{ApiPrefix}}/admin/password/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            password: oldPwd
                        })
                    });
                    
                    if (!verifyResponse.ok || !(await verifyResponse.json())) {
                        showToast('å½“å‰å¯†ç é”™è¯¯', 'error');
                        return;
                    }
                }
                
                // è®¾ç½®æ–°å¯†ç 
                const response = await fetch('{{ApiPrefix}}/admin/password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: newPwd
                    })
                });
                
                if (response.ok) {
                    const successMessage = hasPassword ? 'ç®¡ç†å£ä»¤ä¿®æ”¹æˆåŠŸ' : 'ç®¡ç†å£ä»¤è®¾ç½®æˆåŠŸ';
                    showToast(successMessage);
                    currentPassword = newPwd;
                    updateOutput(`âœ… ${successMessage}å¹¶ç¼“å­˜\n\nç°åœ¨å¯ä»¥ä½¿ç”¨æ–°å£ä»¤è¿›è¡Œç³»ç»Ÿé…ç½®`);
                    cancelChangePassword(); // è¿”å›éªŒè¯ç•Œé¢
                } else {
                    const errorText = await response.text();
                    showToast('æ“ä½œå¤±è´¥: ' + errorText, 'error');
                    updateOutput('âŒ æ“ä½œå¤±è´¥: ' + errorText);
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                updateOutput('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        async function saveCfg() {
            const pwd = currentPassword || document.getElementById('pwd').value;
            if (!pwd || !pwd.trim()) {
                showToast('è¯·å…ˆè®¾ç½®ç®¡ç†å£ä»¤', 'error');
                return;
            }
            
            const config = {
                appId: document.getElementById('appId').value || '',
                appSecret: document.getElementById('appSecret').value || '',
                encryptKey: document.getElementById('encryptKey').value || '',
                verificationToken: document.getElementById('vt').value || ''
            };
            
            if (!config.appId.trim() || !config.appSecret.trim()) {
                showToast('AppId å’Œ AppSecret ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            try {
                const response = await fetch('{{ApiPrefix}}/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Feishu-Admin-Password': pwd
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    showToast('é£ä¹¦é…ç½®ä¿å­˜æˆåŠŸ');
                    updateOutput('âœ… é£ä¹¦åº”ç”¨é…ç½®å·²æ›´æ–°\n\né…ç½®è¯¦æƒ…:\nApp ID: ' + config.appId + '\nApp Secret: ********\nEncrypt Key: ' + (config.encryptKey || '(æœªè®¾ç½®)') + '\nVerification Token: ' + (config.verificationToken || '(æœªè®¾ç½®)'));
                } else if (response.status === 401) {
                    showToast('ç®¡ç†å£ä»¤éªŒè¯å¤±è´¥', 'error');
                    updateOutput('âŒ è®¤è¯å¤±è´¥: ç®¡ç†å£ä»¤ä¸æ­£ç¡®');
                } else {
                    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    updateOutput('âŒ ä¿å­˜å¤±è´¥: HTTP ' + response.status);
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                updateOutput('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        async function checkCfg() {
            try {
                const response = await fetch('{{ApiPrefix}}/config/status');
                const config = await response.json();
                
                if (config.configured) {
                    showToast('é…ç½®æ£€æŸ¥å®Œæˆ');
                    updateOutput('âœ… é£ä¹¦åº”ç”¨é…ç½®å·²å°±ç»ª\n\né…ç½®çŠ¶æ€: å·²é…ç½®\nApp ID: å·²è®¾ç½®\nApp Secret: å·²è®¾ç½®');
                } else {
                    showToast('é…ç½®å°šæœªå®Œæˆ', 'error');
                    updateOutput('âš ï¸ é£ä¹¦åº”ç”¨é…ç½®æœªå®Œæˆ\n\nè¯·è®¾ç½® App ID å’Œ App Secret');
                }
            } catch (error) {
                showToast('æ£€æŸ¥é…ç½®å¤±è´¥: ' + error.message, 'error');
                updateOutput('âŒ æ£€æŸ¥é…ç½®å¤±è´¥: ' + error.message);
            }
        }
        
        async function reg() {
            const pwd = currentPassword || document.getElementById('pwd').value;
            const code = document.getElementById('approvalCode').value;
            const displayName = document.getElementById('displayName').value;
            
            if (!pwd || !pwd.trim()) {
                showToast('è¯·å…ˆéªŒè¯ç®¡ç†å£ä»¤', 'error');
                return;
            }
            
            if (!code || !code.trim()) {
                showToast('è¯·è¾“å…¥å®¡æ‰¹ä»£ç ', 'error');
                return;
            }
            
            try {
                const response = await fetch('{{ApiPrefix}}/approvals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Feishu-Admin-Password': pwd
                    },
                    body: JSON.stringify({
                        approvalCode: code,
                        displayName: displayName || code,
                        description: ''
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast('å®¡æ‰¹ç™»è®°æˆåŠŸ');
                    updateOutput('âœ… å®¡æ‰¹æµç¨‹ç™»è®°æˆåŠŸ\n\nå®¡æ‰¹ä»£ç : ' + code + '\næ˜¾ç¤ºåç§°: ' + (displayName || code) + '\nç™»è®°ID: ' + result.data);
                } else if (response.status === 401) {
                    showToast('ç®¡ç†å£ä»¤éªŒè¯å¤±è´¥', 'error');
                    updateOutput('âŒ è®¤è¯å¤±è´¥: ç®¡ç†å£ä»¤ä¸æ­£ç¡®');
                } else {
                    const errorText = await response.text();
                    showToast('ç™»è®°å¤±è´¥: ' + errorText, 'error');
                    updateOutput('âŒ ç™»è®°å¤±è´¥: ' + errorText);
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                updateOutput('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        async function loadRegistrations() {
            try {
                const response = await fetch('{{ApiPrefix}}/approvals');
                const approvals = await response.json();
                
                if (approvals && approvals.length > 0) {
                    const list = approvals.map(a => `â€¢ ${a.displayName} (${a.approvalCode})`).join('\n');
                    updateOutput('ğŸ“‹ å·²ç™»è®°çš„å®¡æ‰¹æµç¨‹:\n\n' + list);
                } else {
                    updateOutput('ğŸ“‹ æš‚æ— å·²ç™»è®°çš„å®¡æ‰¹æµç¨‹\n\nè¯·å…ˆç™»è®°å®¡æ‰¹ä»£ç ');
                }
            } catch (error) {
                showToast('åŠ è½½å¤±è´¥: ' + error.message, 'error');
                updateOutput('âŒ åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        async function gen() {
            const code = document.getElementById('code').value;
            const className = document.getElementById('className').value;
            
            if (!code || !code.trim()) {
                showToast('è¯·è¾“å…¥å®¡æ‰¹ä»£ç ', 'error');
                return;
            }
            
            try {
                let url = '{{ApiPrefix}}/codegen/' + encodeURIComponent(code);
                if (className && className.trim()) {
                    url += '?className=' + encodeURIComponent(className.trim());
                }
                const response = await fetch(url);
                
                if (response.ok) {
                    const generatedCode = await response.text();
                    showToast('ä»£ç ç”ŸæˆæˆåŠŸ');
                    updateOutput('ğŸš€ ç”Ÿæˆçš„ C# å®ä½“ç±»ä»£ç :\n\n' + generatedCode);
                } else if (response.status === 404) {
                    showToast('å®¡æ‰¹ä»£ç æœªæ‰¾åˆ°', 'error');
                    updateOutput('âŒ å®¡æ‰¹ä»£ç æœªæ‰¾åˆ°: ' + code + '\n\nè¯·ç¡®ä¿:\n1. å®¡æ‰¹ä»£ç æ­£ç¡®\n2. å·²åœ¨é£ä¹¦ä¸­åˆ›å»ºå¯¹åº”å®¡æ‰¹\n3. é£ä¹¦åº”ç”¨é…ç½®æ­£ç¡®');
                } else {
                    const errorText = await response.text();
                    showToast('ç”Ÿæˆå¤±è´¥: ' + errorText, 'error');
                    updateOutput('âŒ ç”Ÿæˆå¤±è´¥: ' + errorText);
                }
            } catch (error) {
                showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
                updateOutput('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
    </script>
</body>
</html>